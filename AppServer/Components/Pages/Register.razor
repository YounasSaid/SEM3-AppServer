@page "/register"
@using AppServer.Models
@inject AppServer.Services.AuthUiService Auth
@inject NavigationManager Nav
@rendermode InteractiveServer

<h2>Opret bruger</h2>

<EditForm Model="model" OnValidSubmit="OnSubmit" FormName="RegisterForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-2"><label>Fornavn</label><br /><InputText class="form-control" @bind-Value="model.FirstName" /></div>
    <div class="mb-2"><label>Efternavn</label><br /><InputText class="form-control" @bind-Value="model.LastName" /></div>
    <div class="mb-2"><label>Skolemail</label><br /><InputText class="form-control" @bind-Value="model.SchoolEmail" /></div>
    <div class="mb-2"><label>Password</label><br /><InputText class="form-control" type="password" @bind-Value="model.Password" />
    </div>

    <div class="mb-2">
        <label>Semester</label><br />
        <InputSelect class="form-select" @bind-Value="model.Semester">
            @for (int i = 1; i <= 7; i++)
            {
                <option value="@i" disabled="@(i != 3)">@i</option>
            }
        </InputSelect>
        <small>(Kun 3 er tilladt i POC)</small>
    </div>

    @if (!string.IsNullOrEmpty(msg)) { <p class="text-success">@msg</p> }
    @if (!string.IsNullOrEmpty(error)) { <p class="text-danger">@error</p> }

    <button class="btn btn-primary" type="submit">Opret</button>
    <button class="btn btn-link" type="button" @onclick="GoLogin">Til login</button>
</EditForm>

@code {
    [SupplyParameterFromForm]
    private RegisterRequest model { get; set; } = new() { Semester = 3 };
    
    private string? msg;
    private string? error;

    private async Task OnSubmit()
    {
        var (ok, code) = await Auth.RegisterAsync(model);
        if (ok)
        {
            msg = "Bruger oprettet â€“ log ind";
            await Task.Delay(800);
            Nav.NavigateTo("/login");
        }
        else
        {
            error = code switch
            {
                "INVALID_Semester" => "Kun semester 3 er tilladt i denne POC.",
                "EMAIL_TAKEN"      => "Mailen er allerede brugt.",
                _                  => "Noget gik galt."
            };
        }
    }

    private void GoLogin() => Nav.NavigateTo("/login");
}
